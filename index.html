<!-- (PHẦN TRÊN GIỮ NGUYÊN 100%, TAO KHÔNG ĐỤNG) -->

<script>
/* ===== ADD: FRONTEND ANTI-CHEAT STATE ===== */
let lastActionTime = 0;

/* ===== ADD: SYNC POINTS FROM BACKEND ===== */
async function syncPointsFromBackend(){
  if(!wallet) return;
  try{
    const res = await fetch(BACKEND_URL + "/leaderboard?range=48h");
    if(!res.ok) return;
    const data = await res.json();
    const me = data.find(u => u.wallet === wallet);
    if(me && typeof me.points === "number"){
      points = me.points;
      savePoints();
    }
  }catch{}
}

/* ===== ADD: SAFE SEND GAME RESULT ===== */
async function sendGameResult(profit, volume){
  if(!wallet) return;
  try{
    await fetch(BACKEND_URL + "/game/result",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ wallet, profit, volume })
    });
  }catch{}
}

/* ===== GAME (CHỈ BỔ SUNG, KHÔNG SỬA LOGIC CŨ) ===== */
function startRound(){
  const now = Date.now();

  /* === ADD: ANTI-SPAM CLICK === */
  if(now - lastActionTime < 500){
    showToast("Too fast");
    return;
  }
  lastActionTime = now;

  /* === ADD: REQUIRE WALLET === */
  if(!wallet){
    showToast("Connect wallet first");
    return;
  }

  if(running)return;
  bet=+$("bet").value; auto=+$("auto").value||null;
  if(!bet||bet<1||bet>points){$("warn").textContent="Invalid bet";return;}
  $("warn").textContent="";
  points-=bet; savePoints();
  multiplier=1;running=true;exited=false;
  $("stopBtn").disabled=false; $("display").textContent="1.00x";
  $("bet").value=""; $("auto").value="";
  const crash=genCrash();

  const loop=setInterval(()=>{
    if(!running){clearInterval(loop);return;}
    multiplier+=0.03;
    $("display").textContent=multiplier.toFixed(2)+"x";
    if(auto && multiplier>=auto && !exited) cashout();

    if(multiplier>=crash){
      clearInterval(loop);
      running=false;
      $("stopBtn").disabled=true;
      addHistory(crash);

      /* === ADD: SEND LOSS RESULT === */
      if(!exited){
        sendGameResult(0, bet);
        syncPointsFromBackend();
        showToast(`Crashed at ${crash.toFixed(2)}x`);
      }
    }
  },30);
}

function cashout(){
  if(!running||exited)return;
  exited=true;

  const win=Math.floor(bet*multiplier);
  points+=win; savePoints();
  $("stopBtn").disabled=true;

  /* === ADD: SEND WIN RESULT === */
  sendGameResult(win, bet).then(syncPointsFromBackend);

  showToast(`+${win} points`);
}
</script>
