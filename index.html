<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Solspace</title>

<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

<style>
body {
  background: radial-gradient(circle at top, #0b1a3a, #050814);
  color: #fff;
  font-family: Arial;
  margin: 0;
}
.container { max-width: 420px; margin: auto; padding: 16px; }
.card { background: #0c1635; border-radius: 14px; padding: 16px; margin-bottom: 14px; }
.multiplier { font-size: 56px; font-weight: bold; text-align: center; }
button {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: #2cffb3;
  font-size: 18px;
  font-weight: bold;
  margin-top: 6px;
}
button.stop { background: #222; color: #999; }
input, select {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  margin-bottom: 8px;
}
.history { display: flex; gap: 6px; overflow-x: auto; }
.history span { background: #15245a; padding: 6px 10px; border-radius: 8px; }
.warn { color: #ff5a5a; font-size: 14px; }
</style>
</head>

<body>
<div class="container">
<h2>ðŸš€ Solspace</h2>

<!-- CONNECT WALLET -->
<div class="card">
  <select id="walletType">
    <option value="auto">Auto Detect Wallet</option>
    <option value="phantom">Phantom</option>
    <option value="solflare">Solflare</option>
    <option value="backpack">Backpack</option>
  </select>
  <button onclick="connectWallet()">Connect Wallet</button>
  <div id="wallet"></div>
</div>

<!-- HISTORY -->
<div class="card">
  <div class="history" id="history"></div>
</div>

<!-- GAME -->
<div class="card">
  <div class="multiplier" id="display">1.00x</div>

  <input id="bet" type="number" placeholder="Bet Points">
  <input id="auto" type="number" step="0.01" placeholder="Auto Cashout">

  <div id="warn" class="warn"></div>

  <button onclick="startRound()">START</button>
  <button class="stop" onclick="cashout()">STOP</button>

  <p>Your Points: <b id="points">0</b></p>
</div>

<!-- DEPOSIT -->
<div class="card">
  <input id="depositAmount" type="number" step="0.001" placeholder="Enter SOL (min 0.005)">
  <button onclick="depositSOL()">DEPOSIT SOL</button>
</div>
</div>

<script>
/* ===== CONFIG ===== */
const BACKEND_URL = "https://solspace-backend-i089.onrender.com";
const SYSTEM_WALLET = new solanaWeb3.PublicKey(
  "H2yVMrEbexHFdsAMFQtBY3Lp3BBz6cu6VVJwyiommqxZ"
);

/* ===== STATE ===== */
let provider = null;
let wallet = null;
let userPoints = Number(localStorage.getItem("points")) || 0;
updatePoints();

/* ===== POINT ===== */
function savePoints(){
  localStorage.setItem("points", userPoints);
  updatePoints();
}
function updatePoints(){
  document.getElementById("points").innerText = userPoints;
}

/* ===== WALLET CONNECT (MULTI WALLET) ===== */
async function connectWallet(){
  try {
    const type = document.getElementById("walletType").value;

    if (!window.solana) {
      alert("No Solana wallet detected");
      return;
    }

    provider = window.solana;

    // Optional checks (not mandatory, just UX)
    if (type === "phantom" && !provider.isPhantom) {
      alert("Please open Phantom wallet");
      return;
    }
    if (type === "solflare" && !provider.isSolflare) {
      alert("Please open Solflare wallet");
      return;
    }
    if (type === "backpack" && !provider.isBackpack) {
      alert("Please open Backpack wallet");
      return;
    }

    const resp = await provider.connect();
    wallet = resp.publicKey.toString();

    document.getElementById("wallet").innerText =
      wallet.slice(0,4) + "..." + wallet.slice(-4);

  } catch (e) {
    console.error(e);
    alert("Wallet connection failed");
  }
}

/* ===== GAME LOGIC (UNCHANGED) ===== */
let liveMultiplier = 1;
let crashPoint = 0;
let running = false;
let exited = false;
let bet = 0;
let auto = null;

function genCrash(){
  const r = Math.random();
  if(r < 0.6) return 1 + Math.random() * 0.5;
  if(r < 0.85) return 1.5 + Math.random() * 1.5;
  return 3 + Math.random() * 6;
}

function startRound(){
  if(running) return;

  bet = +document.getElementById("bet").value;
  auto = +document.getElementById("auto").value || null;

  if(!bet || bet > userPoints){
    document.getElementById("warn").innerText = "Not enough points";
    return;
  }

  document.getElementById("warn").innerText = "";
  userPoints -= bet;
  savePoints();

  liveMultiplier = 1;
  crashPoint = genCrash();
  running = true;
  exited = false;

  const loop = setInterval(()=>{
    if(!running){
      clearInterval(loop);
      return;
    }

    liveMultiplier += 0.03;
    document.getElementById("display").innerText =
      liveMultiplier.toFixed(2)+"x";

    if(!exited && auto && liveMultiplier >= auto){
      cashout();
    }

    if(liveMultiplier >= crashPoint){
      running = false;
      addHistory(crashPoint);
    }
  },30);
}

function cashout(){
  if(!running || exited) return;
  exited = true;
  const win = Math.floor(bet * liveMultiplier);
  userPoints += win;
  savePoints();
}

function addHistory(v){
  const s = document.createElement("span");
  s.innerText = v.toFixed(2)+"x";
  document.getElementById("history").prepend(s);
}

/* ===== DEPOSIT SOL (PHANTOM / SOLFLARE OK) ===== */
async function depositSOL(){
  try {
    if(!provider || !provider.publicKey){
      alert("Please connect wallet first");
      return;
    }

    const sol = Number(document.getElementById("depositAmount").value);
    if(isNaN(sol) || sol < 0.005){
      alert("Minimum deposit is 0.005 SOL");
      return;
    }

    const connection = new solanaWeb3.Connection(
      solanaWeb3.clusterApiUrl("mainnet-beta"),
      "confirmed"
    );

    const tx = new solanaWeb3.Transaction().add(
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: provider.publicKey,
        toPubkey: SYSTEM_WALLET,
        lamports: Math.floor(sol * solanaWeb3.LAMPORTS_PER_SOL)
      })
    );

    tx.feePayer = provider.publicKey;
    tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

    const { signature } = await provider.signAndSendTransaction(tx);
    await connection.confirmTransaction(signature, "confirmed");

    const res = await fetch(BACKEND_URL + "/check-deposit",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ wallet: provider.publicKey.toString() })
    });
    const data = await res.json();

    if(data.ok && data.addedPoint > 0){
      userPoints += data.addedPoint;
      savePoints();
      alert("Deposit successful +" + data.addedPoint + " points");
    } else {
      alert("SOL sent. Points will update shortly.");
    }

  } catch(e){
    console.error(e);
    alert("Transaction failed or cancelled");
  }
}
</script>
</body>
</html>
