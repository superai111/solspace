<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Solspace</title>

<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

<style>
body {
  background: radial-gradient(circle at top, #0b1a3a, #050814);
  color: #fff;
  font-family: Arial;
  margin: 0;
}
.container { max-width: 420px; margin: auto; padding: 16px; }
.card { background: #0c1635; border-radius: 14px; padding: 16px; margin-bottom: 14px; }
.multiplier { font-size: 56px; font-weight: bold; text-align: center; }
button {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: #2cffb3;
  font-size: 18px;
  font-weight: bold;
  margin-top: 6px;
}
button.stop { background: #222; color: #999; }
input, select {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  margin-bottom: 8px;
}
.history { display: flex; gap: 6px; overflow-x: auto; }
.history span { background: #15245a; padding: 6px 10px; border-radius: 8px; }
.warn { color: #ff5a5a; font-size: 14px; }
</style>
</head>

<body>
<div class="container">
<h2>üöÄ Solspace</h2>

<!-- CONNECT WALLET (STEP A) -->
<div class="card">
  <select id="walletType">
    <option value="phantom">Phantom</option>
    <option value="solflare">Solflare</option>
    <option value="backpack">Backpack</option>
  </select>
  <button onclick="connectWallet()">Connect Wallet</button>
  <div id="wallet"></div>
</div>

<!-- HISTORY -->
<div class="card">
  <div class="history" id="history"></div>
</div>

<!-- GAME (GI·ªÆ NGUY√äN) -->
<div class="card">
  <div class="multiplier" id="display">1.00x</div>

  <input id="bet" type="number" placeholder="Bet Points">
  <input id="auto" type="number" step="0.01" placeholder="Auto Cashout">

  <div id="warn" class="warn"></div>

  <button onclick="startRound()">START</button>
  <button class="stop" id="stopBtn" onclick="cashout()" disabled>STOP</button>

  <p>Your Points: <b id="points">0</b></p>
</div>

<!-- DEPOSIT (CH∆ØA ƒê·ªòNG) -->
<div class="card">
  <input id="depositAmount" type="number" step="0.001" placeholder="SOL amount (>= 0.005)">
  <button onclick="depositSOL()">DEPOSIT SOL</button>
</div>
</div>

<script>
/* ================= DOM ELEMENTS (FIX L·ªñI BI·∫æN) ================= */
const betInput   = document.getElementById("bet");
const autoInput  = document.getElementById("auto");
const warn       = document.getElementById("warn");
const display    = document.getElementById("display");
const stopBtn    = document.getElementById("stopBtn");
const history    = document.getElementById("history");
const pointsEl   = document.getElementById("points");

/* ================= STEP A: CONNECT WALLET ================= */

let provider = null;
let wallet = null;

function isMobile(){
  return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
}

async function connectWallet(){
  const type = document.getElementById("walletType").value;
  provider = null;

  // 1Ô∏è‚É£ DESKTOP EXTENSION
  if (type === "phantom" && window.solana?.isPhantom) provider = window.solana;
  if (type === "solflare" && window.solflare?.isSolflare) provider = window.solflare;
  if (type === "backpack" && window.backpack?.isBackpack) provider = window.backpack;

  if (provider) {
    try {
      const res = await provider.connect();
      wallet = res.publicKey.toString();
      document.getElementById("wallet").innerText =
        wallet.slice(0,4) + "..." + wallet.slice(-4);
      return;
    } catch {
      alert("Wallet connection rejected");
      return;
    }
  }

  // 2Ô∏è‚É£ MOBILE DEEPLINK
  if (isMobile()) {
    const url = encodeURIComponent(location.href);
    if (type === "phantom") location.href = `https://phantom.app/ul/browse/${url}`;
    if (type === "solflare") location.href = `https://solflare.com/ul/browse/${url}`;
    if (type === "backpack") location.href = `https://backpack.app/ul/browse/${url}`;
    return;
  }

  alert("Wallet not detected. Install wallet or open in wallet browser.");
}

/* ================= PH·∫¶N D∆Ø·ªöI GI·ªÆ NGUY√äN (CH·ªà FIX BI·∫æN DOM) ================= */

/* GAME STATE */
let points = Number(localStorage.getItem("points")) || 0;
pointsEl.innerText = points;

let running=false, exited=false, bet=0, auto=null, multiplier=1;

function savePoints(){
  localStorage.setItem("points", points);
  pointsEl.innerText = points;
}

function genCrash(){
  const r=Math.random();
  if(r<0.6) return 1+Math.random()*0.5;
  if(r<0.85) return 1.5+Math.random()*1.5;
  return 3+Math.random()*6;
}

function startRound(){
  if(running) return;
  bet=+betInput.value;
  auto=+autoInput.value||null;
  if(!bet||bet>points){ warn.innerText="Not enough points"; return; }
  warn.innerText="";
  points-=bet; savePoints();
  multiplier=1; exited=false; running=true;
  stopBtn.disabled=false;
  const crash=genCrash();
  const loop=setInterval(()=>{
    if(!running){clearInterval(loop);return;}
    multiplier+=0.03;
    display.innerText=multiplier.toFixed(2)+"x";
    if(auto && multiplier>=auto && !exited) cashout();
    if(multiplier>=crash){
      running=false;
      stopBtn.disabled=true;
      addHistory(crash);
    }
  },30);
}

function cashout(){
  if(!running||exited) return;
  exited=true;
  points+=Math.floor(bet*multiplier);
  savePoints();
  stopBtn.disabled=true;
}

function addHistory(v){
  const s=document.createElement("span");
  s.innerText=v.toFixed(2)+"x";
  history.prepend(s);
}

function depositSOL(){
  alert("Deposit: s·∫Ω l√†m ·ªü b∆∞·ªõc sau");
}
</script>
</body>
</html>
