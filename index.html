<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Solpump Mini</title>

<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

<style>
body {
  background: radial-gradient(circle at top, #0b1a3a, #050814);
  color: #fff;
  font-family: Arial;
  margin: 0;
}
.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}
.card {
  background: #0c1635;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 14px;
}
.multiplier {
  font-size: 56px;
  font-weight: bold;
  text-align: center;
}
button {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: #2cffb3;
  font-size: 18px;
  font-weight: bold;
  margin-top: 6px;
}
button.stop {
  background: #222;
  color: #999;
}
button.stop:disabled {
  opacity: 0.5;
}
input {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  margin-bottom: 8px;
}
.history {
  display: flex;
  gap: 6px;
  overflow-x: auto;
}
.history span {
  background: #15245a;
  padding: 6px 10px;
  border-radius: 8px;
}
.warn { color:#ff5a5a; font-size:14px; }
.profit { color:#2cffb3; font-size:14px; }
</style>
</head>

<body>
<div class="container">

<h2>ðŸš€ Solpump Mini</h2>

<div class="card">
  <button onclick="connectWallet()">Connect Phantom Wallet</button>
  <div id="wallet"></div>
</div>

<div class="card">
  <div class="history" id="history"></div>
</div>

<div class="card">
  <div class="multiplier" id="display">1.00x</div>

  <input id="bet" type="number" placeholder="Bet points">
  <input id="auto" type="number" step="0.01" placeholder="Auto Cashout">

  <div id="warn" class="warn"></div>
  <div id="profit" class="profit"></div>

  <button onclick="startRound()">START</button>
  <button id="stopBtn" class="stop" onclick="cashout()">STOP</button>

  <p>Your Points: <b id="points">0</b></p>
</div>

<div class="card">
  <button onclick="depositSOL()">NAP POINT (SOL)</button>
</div>

</div>

<script>
/* ===== SOLANA ===== */
const connection = new solanaWeb3.Connection(
  solanaWeb3.clusterApiUrl("mainnet-beta"),
  "confirmed"
);

const SYSTEM_WALLET = new solanaWeb3.PublicKey(
  "H2yVMrEbexHFdsAMFQtBY3Lp3BBz6cu6VVJwyiommqxZ"
);

let wallet = null;

/* ===== POINT ===== */
let userPoints = Number(localStorage.getItem("points")) || 1000;
updatePoints();

function savePoints() {
  localStorage.setItem("points", userPoints);
  updatePoints();
}
function updatePoints() {
  points.innerText = userPoints.toFixed(2);
}

/* ===== GAME STATE ===== */
let liveMultiplier = 1.0;
let crashPoint = 0;
let running = false;
let crashed = false;
let exited = false;
let bet = 0;
let auto = null;
let interval = null;
let roundStartTime = 0;
const MIN_RUN_TIME = 600;

/* ===== WALLET ===== */
async function connectWallet() {
  if (!window.solana || !window.solana.isPhantom) {
    alert("Má»Ÿ trang trong Phantom Wallet");
    return;
  }
  const r = await window.solana.connect();
  wallet = r.publicKey;
  walletDiv.innerText =
    "Wallet: " + wallet.toString().slice(0,4) + "..." + wallet.toString().slice(-4);
}

/* ===== CRASH GEN ===== */
function genCrash() {
  const r = Math.random();
  if (r < 0.6) return 1 + Math.random() * 0.5;
  if (r < 0.85) return 1.5 + Math.random() * 1.5;
  return 3 + Math.random() * 6;
}

/* ===== START ===== */
function startRound() {
  if (running) return;

  warn.innerText = "";
  profit.innerText = "";
  stopBtn.disabled = false;

  bet = Number(betInput.value);
  auto = Number(autoInput.value) || null;

  if (!bet || bet > userPoints) {
    warn.innerText = "Sá»‘ point khÃ´ng Ä‘á»§, báº¡n cáº§n náº¡p thÃªm";
    return;
  }

  userPoints -= bet;
  savePoints();

  liveMultiplier = 1.0;
  crashPoint = genCrash();
  running = true;
  crashed = false;
  exited = false;

  roundStartTime = Date.now();
  interval = setInterval(loop, 25);
}

/* ===== LOOP ===== */
function loop() {
  if (!running || crashed) return;

  let speed = 0.02;
  if (liveMultiplier > 1.5) speed = 0.035;
  if (liveMultiplier > 2.5) speed = 0.06;

  if (Math.random() < 0.04) return;

  liveMultiplier += speed;
  display.innerText = liveMultiplier.toFixed(2) + "x";

  if (!exited && auto && liveMultiplier >= auto) cashout();

  if (Date.now() - roundStartTime >= MIN_RUN_TIME &&
      liveMultiplier >= crashPoint) crash();
}

/* ===== STOP ===== */
function cashout() {
  if (!running || exited || crashed) return;
  exited = true;

  const win = bet * liveMultiplier;
  userPoints += win;
  savePoints();

  profit.innerText = "+" + (win - bet).toFixed(2) + " point";
  stopBtn.disabled = true;
}

/* ===== CRASH ===== */
function crash() {
  crashed = true;
  running = false;
  clearInterval(interval);

  display.innerText = crashPoint.toFixed(2) + "x";
  addHistory(crashPoint);
}

/* ===== HISTORY ===== */
function addHistory(v) {
  const s = document.createElement("span");
  s.innerText = v.toFixed(2) + "x";
  s.style.background = v < 1.3 ? "#7a1c1c" : "#1c7a52";
  history.prepend(s);
}

/* ===== Náº P SOL â€“ XÃC THá»°C ON-CHAIN ===== */
async function depositSOL() {
  try {
    if (!wallet) await connectWallet();
    if (!wallet) return;

    const sol = Number(prompt("Nháº­p sá»‘ SOL muá»‘n náº¡p (>= 0.01):"));
    if (!sol || sol <= 0) return;

    const tx = new solanaWeb3.Transaction().add(
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: wallet,
        toPubkey: SYSTEM_WALLET,
        lamports: Math.floor(sol * solanaWeb3.LAMPORTS_PER_SOL)
      })
    );

    tx.feePayer = wallet;
    tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

    const { signature } = await window.solana.signAndSendTransaction(tx);
    await connection.confirmTransaction(signature, "confirmed");

    const parsed = await connection.getParsedTransaction(signature, {
      maxSupportedTransactionVersion: 0
    });

    let receivedLamports = 0;
    parsed.transaction.message.instructions.forEach(ix => {
      if (
        ix.program === "system" &&
        ix.parsed?.type === "transfer" &&
        ix.parsed.info.destination === SYSTEM_WALLET.toString() &&
        ix.parsed.info.source === wallet.toString()
      ) {
        receivedLamports += Number(ix.parsed.info.lamports);
      }
    });

    const receivedSOL = receivedLamports / solanaWeb3.LAMPORTS_PER_SOL;
    if (receivedSOL < 0.01) {
      alert("SOL < 0.01, khÃ´ng cá»™ng point");
      return;
    }

    const earned = Math.floor(receivedSOL * 1000);
    userPoints += earned;
    savePoints();

    alert(`Náº¡p thÃ nh cÃ´ng ${receivedSOL} SOL\n+${earned} point`);
  } catch (e) {
    console.error(e);
    alert("Náº¡p SOL tháº¥t báº¡i");
  }
}
</script>

</body>
  </html>
