<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Solpump Mini</title>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      background: #0b0f19;
      color: white;
      font-family: Arial;
      padding: 20px;
    }
    .card {
      background: #121826;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    button {
      background: #00ffa3;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: bold;
      width: 100%;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<h1>ðŸš€ Solpump Mini</h1>

<div class="card">
  <button onclick="connectWallet()">Káº¿t ná»‘i vÃ­ Phantom</button>
  <p id="wallet"></p>
</div>

<div class="card">
  <h3>Mua Ä‘iá»ƒm</h3>
  <p>Tá»‘i thiá»ƒu 0.01 SOL â€” 10 Ä‘iá»ƒm / 0.01 SOL</p>
  <input id="solAmount" type="number" step="0.001" min="0.01" placeholder="Nháº­p SOL (vd: 0.06)" />
  <p id="pointsPreview"></p>
  <button onclick="buyPoints()">Mua Ä‘iá»ƒm</button>
</div>

<div class="card">
  <h3>Thá»‘ng kÃª</h3>
  <p>Tá»•ng SOL Ä‘Ã£ náº¡p: <span id="totalSol">0</span></p>
  <p>Tá»•ng giáº£i (50%): <span id="prize">0</span></p>
</div>

<script>
/* ================== CONFIG ================== */
const SYSTEM_WALLET = "H2yVMrEbexHFdsAMFQtBY3Lp3BBz6cu6VVJwyiommqxZ";
const POINT_RATE = 1000; // 1 SOL = 1000 Ä‘iá»ƒm

const supabase = window.supabase.createClient(
  "https://twnovzaygfpxydkzwzsd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3bm92emF5Z2ZweHlka3p3enNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMTU2MzEsImV4cCI6MjA4MTU5MTYzMX0.T5s5vqGPDXYqpr1kA85lh-2VF_rUdXg8YCutq0QZ5j4"
);

let userWallet = null;
const connection = new solanaWeb3.Connection(
  solanaWeb3.clusterApiUrl("devnet")
);

/* ================== WALLET ================== */
async function connectWallet() {
  const resp = await window.solana.connect();
  userWallet = resp.publicKey.toString();
  document.getElementById("wallet").innerText = userWallet;
  loadStats();
}

/* ================== POINT PREVIEW ================== */
document.getElementById("solAmount").addEventListener("input", () => {
  const sol = parseFloat(solAmount.value || 0);
  const points = Math.floor(sol * POINT_RATE);
  pointsPreview.innerText = points + " Ä‘iá»ƒm";
});

/* ================== BUY POINTS ================== */
async function buyPoints() {
  const sol = parseFloat(solAmount.value);
  if (!sol || sol < 0.01) {
    alert("Tá»‘i thiá»ƒu 0.01 SOL");
    return;
  }

  const tx = new solanaWeb3.Transaction().add(
    solanaWeb3.SystemProgram.transfer({
      fromPubkey: window.solana.publicKey,
      toPubkey: new solanaWeb3.PublicKey(SYSTEM_WALLET),
      lamports: sol * solanaWeb3.LAMPORTS_PER_SOL,
    })
  );

  const signature = await window.solana.signAndSendTransaction(tx);
  await connection.confirmTransaction(signature.signature);

  const points = Math.floor(sol * POINT_RATE);

  await supabase.from("users").upsert({
    wallet: userWallet,
    points: points,
    total_paid_sol: sol
  }, { onConflict: ["wallet"] });

  alert("Mua Ä‘iá»ƒm thÃ nh cÃ´ng!");
  loadStats();
}

/* ================== STATS ================== */
async function loadStats() {
  const { data } = await supabase.from("users").select("total_paid_sol");
  const total = data.reduce((s, r) => s + Number(r.total_paid_sol || 0), 0);
  document.getElementById("totalSol").innerText = total.toFixed(3);
  document.getElementById("prize").innerText = (total * 0.5).toFixed(3);
}
</script>

</body>
</html>
