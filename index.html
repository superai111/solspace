<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Solpump Mini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <style>
    body {
      background: #0b0f1a;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .box {
      background: #111827;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    button {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: #00ff99;
      font-weight: bold;
      font-size: 16px;
    }
    input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      border: none;
    }
  </style>
</head>
<body>

<h2>ðŸš€ Solpump Mini</h2>

<div class="box">
  <button onclick="connectWallet()">Káº¿t ná»‘i vÃ­ Phantom</button>
  <div id="wallet" style="margin-top:8px;"></div>
</div>

<div class="box">
  <h3>Mua Ä‘iá»ƒm</h3>
  <div>1 SOL = 1000 Ä‘iá»ƒm (tá»‘i thiá»ƒu 0.01 SOL)</div>
  <input id="solInput" type="number" step="0.001" placeholder="Nháº­p SOL (vd 0.06)" />
  <div id="pointPreview"></div>
  <button onclick="buyPoints()">Mua Ä‘iá»ƒm</button>
</div>

<div class="box">
  <h3>Thá»‘ng kÃª</h3>
  <div>Tá»•ng SOL Ä‘Ã£ náº¡p: <b id="totalSol">0</b> SOL</div>
  <div>Tá»•ng giáº£i (50%): <b id="totalPrize">0</b> SOL</div>
</div>

<script>
/* ================= CONFIG ================= */
const SYSTEM_WALLET = "H2yVMrEbexHFdsAMFQtBY3Lp3BBz6cu6VVJwyiommqxZ";

const SUPABASE_URL = "https://twnovzaygfpxydkzwzsd.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3bm92emF5Z2ZweHlka3p3enNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMTU2MzEsImV4cCI6MjA4MTU5MTYzMX0.T5s5vqGPDXYqpr1kA85lh-2VF_rUdXg8YCutq0QZ5j4";

const supabase = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const connection = new solanaWeb3.Connection(
  solanaWeb3.clusterApiUrl("mainnet-beta")
);

let walletAddress = null;

/* ================= WALLET ================= */
async function connectWallet() {
  if (!window.solana || !window.solana.isPhantom) {
    alert("CÃ i Phantom Wallet trÆ°á»›c");
    return;
  }
  const res = await window.solana.connect();
  walletAddress = res.publicKey.toString();
  document.getElementById("wallet").innerText = walletAddress;
}

/* ================= UI ================= */
document.getElementById("solInput").addEventListener("input", () => {
  const sol = parseFloat(solInput.value || 0);
  const points = Math.floor(sol * 1000);
  document.getElementById("pointPreview").innerText =
    points > 0 ? `${points} Ä‘iá»ƒm` : "";
});

/* ================= BUY ================= */
async function buyPoints() {
  const sol = parseFloat(solInput.value);
  if (!walletAddress) return alert("ChÆ°a káº¿t ná»‘i vÃ­");
  if (!sol || sol < 0.01) return alert("Tá»‘i thiá»ƒu 0.01 SOL");

  const tx = new solanaWeb3.Transaction().add(
    solanaWeb3.SystemProgram.transfer({
      fromPubkey: new solanaWeb3.PublicKey(walletAddress),
      toPubkey: new solanaWeb3.PublicKey(SYSTEM_WALLET),
      lamports: solanaWeb3.LAMPORTS_PER_SOL * sol
    })
  );

  const { blockhash } = await connection.getLatestBlockhash();
  tx.recentBlockhash = blockhash;
  tx.feePayer = new solanaWeb3.PublicKey(walletAddress);

  const signed = await window.solana.signTransaction(tx);
  await connection.sendRawTransaction(signed.serialize());

  const points = Math.floor(sol * 1000);

  await supabase.from("users").upsert({
    wallet: walletAddress,
    points: points,
    total_paid_sol: sol
  });

  alert("Mua Ä‘iá»ƒm thÃ nh cÃ´ng");
  loadStats();
}

/* ================= STATS ================= */
async function loadStats() {
  const { data } = await supabase
    .from("users")
    .select("total_paid_sol");

  const total = data.reduce((a, b) => a + Number(b.total_paid_sol), 0);
  document.getElementById("totalSol").innerText = total.toFixed(3);
  document.getElementById("totalPrize").innerText = (total * 0.5).toFixed(3);
}

loadStats();
</script>
</body>
</html>
